version: '3.8'

services:
  # 1. 数据库服务
  ruoyi-pg:
    image: postgres:15-alpine
    container_name: ${DB_CONTAINER_NAME}
    restart: always
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME}
    ports:
      - "${DB_EXTERNAL_PORT}:5432"
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${DB_USER}"]
      interval: 5s
    networks:
      - ruoyi-network

  # 2. Redis 服务
  ruoyi-redis:
    image: redis:7-alpine
    container_name: ruoyi-redis
    restart: always
    networks:
      - ruoyi-network

  # 3. 后端服务
  ruoyi-backend-pg:
    build:
      context: ./ruoyi-fastapi-backend
      dockerfile: Dockerfile.pg
    container_name: eve_backend
    restart: always
    ports:
      - "${BACKEND_EXTERNAL_PORT}:9099"
    environment:
      - ENV=dockerpg
      - DB_HOST=ruoyi-pg  # 对应数据库服务名
      - DB_PORT=5432
      - DB_USERNAME=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE=${DB_NAME}
      - EVE_CLIENT_ID=${EVE_CLIENT_ID}
      - EVE_CLIENT_SECRET=${EVE_CLIENT_SECRET}
      - EVE_CALLBACK_URL=${EVE_CALLBACK_URL}
      - FRONTEND_URL=${FRONTEND_URL}
    depends_on:
      ruoyi-pg:
        condition: service_healthy
      ruoyi-redis:
        condition: service_started
    networks:
      - ruoyi-network

  # 4. SDE 处理器 (指向上一级)
  sde-processor:
    build:
      context: ../eve-sde-processor
    container_name: eve_sde_worker
    restart: always
    environment:
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@ruoyi-pg:5432/${DB_NAME}
    depends_on:
      ruoyi-pg:
        condition: service_healthy
    networks:
      - ruoyi-network

  # 5. 前端服务
  frontend:
    build:
      context: ./ruoyi-fastapi-frontend
    container_name: eve_frontend
    restart: always
    ports:
      - "${FRONTEND_EXTERNAL_PORT}:80"
    networks:
      - ruoyi-network

networks:
  ruoyi-network: # 统一使用你要求的网络名称
    driver: bridge