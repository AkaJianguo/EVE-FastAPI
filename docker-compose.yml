version: '3.8'

services:
  # 1. 数据库服务
  EVE-pg:
    image: postgres:15-alpine
    container_name: ${DB_CONTAINER_NAME}
    restart: always
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME}
    ports:
      - "${DB_EXTERNAL_PORT}:5432"
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${DB_USER}"]
      interval: 5s
    networks:
      - EVE-network

  # 2. Redis 服务
  EVE-redis:
    image: redis:7-alpine
    container_name: EVE-redis
    restart: always
    networks:
      - EVE-network

  # 3. 后端服务
  EVE-backend-pg:
    build:
      context: ./EVE-fastapi-backend
      dockerfile: Dockerfile.pg
    container_name: eve_backend
    restart: always
    ports:
      - "${BACKEND_EXTERNAL_PORT}:9099"
    environment:
      - APP_ENV=dockerpg
      - ENV=dockerpg
      - DB_HOST=EVE-pg  # 对应数据库服务名
      - DB_PORT=5432
      - DB_USERNAME=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE=${DB_NAME}
      - EVE_CLIENT_ID=${EVE_CLIENT_ID}
      - EVE_CLIENT_SECRET=${EVE_CLIENT_SECRET}
      - EVE_CALLBACK_URL=${EVE_CALLBACK_URL}
      - FRONTEND_URL=${FRONTEND_URL}
    depends_on:
      EVE-pg:
        condition: service_healthy
      EVE-redis:
        condition: service_started
    networks:
      - EVE-network

  # 4. SDE 处理器 (指向上一级)
  # sde-processor:
  #   build:
  #     context: ../eve-sde-processor
  #   container_name: eve_sde_worker
  #   restart: always
  #   environment:
  #     - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@EVE-pg:5432/${DB_NAME}
  #   depends_on:
  #     EVE-pg:
  #       condition: service_healthy
  #   networks:
  #     - EVE-network

  # 5. 前端服务
  frontend:
    build:
      context: ./EVE-fastapi-frontend
    container_name: eve_frontend
    restart: always
    ports:
      - "${FRONTEND_EXTERNAL_PORT}:80"
    volumes:
      # 建议使用相对当前目录的路径，并确保文件确实存在
      - ./EVE-fastapi-frontend/bin/nginx.dockerpg.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - EVE-network

networks:
  EVE-network: # 统一使用你要求的网络名称
    driver: bridge