version: '3.8'

services:
  # 1. 数据库服务 - PostgreSQL 15
  eve-pg:
    image: postgres:15-alpine
    container_name: ${DB_CONTAINER_NAME}
    restart: always
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME}
    ports:
      - "${DB_EXTERNAL_PORT}:5432"
    volumes:
      - ../postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${DB_USER}", "-d", "${DB_NAME}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - eve-network

  # 2. Redis 缓存
  eve-redis:
    image: redis:7-alpine
    container_name: eve-redis
    restart: always
    networks:
      - eve-network

  # 3. 后端 FastAPI 服务
  eve-backend-pg:
    build:
      context: ./ruoyi-fastapi-backend
      dockerfile: Dockerfile.pg
    container_name: eve_backend
    restart: always
    volumes:
      - ./ruoyi-fastapi-backend:/app
    ports:
      - "${BACKEND_EXTERNAL_PORT}:9099"
    environment:
      # 应用配置
      - APP_ENV=dockerpg
      - ENV=dockerpg
      # 数据库连接
      - DB_HOST=${DB_SERVICE_NAME}
      - DB_PORT=5432
      - DB_USERNAME=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE=${DB_NAME}
      # Redis 连接
      - REDIS_HOST=${REDIS_SERVICE_NAME}
      - REDIS_PORT=6379
      # EVE SSO 配置（本地开发）
      - EVE_CLIENT_ID=${EVE_CLIENT_ID}
      - EVE_CLIENT_SECRET=${EVE_CLIENT_SECRET}
      - EVE_CALLBACK_URL=${EVE_CALLBACK_URL}
      - FRONTEND_URL=${FRONTEND_URL}
    depends_on:
      eve-pg:
        condition: service_healthy
      eve-redis:
        condition: service_started
    networks:
      - eve-network

  # 4. 前端 Nginx 服务
  frontend:
    build:
      context: ./ruoyi-fastapi-frontend
      dockerfile: Dockerfile
    container_name: eve_frontend
    restart: always
    ports:
      - "${FRONTEND_EXTERNAL_PORT}:80"
    environment:
      - BACKEND_HOST=${BACKEND_HOST}
    volumes:
      # 使用 nginx.dockerpg.conf（本地测试配置）
      - ./ruoyi-fastapi-frontend/bin/nginx.dockerpg.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - eve-backend-pg
    networks:
      - eve-network

  # 前端本地开发热更（Vite dev server）
  frontend-dev:
    image: node:20-alpine
    container_name: eve_frontend_dev
    working_dir: /app
    command: sh -c "npm config set registry https://registry.npmmirror.com && npm install --no-package-lock && npm run dev -- --host --port 5173 --strictPort"
    ports:
      - "5173:5173"      # Vite 页面
      - "24678:24678"    # Vite HMR
    volumes:
      - ./ruoyi-fastapi-frontend:/app
    environment:
      - BACKEND_HOST=${BACKEND_HOST}
      - BACKEND_PORT=9099
    depends_on:
      - eve-backend-pg
    networks:
      - eve-network

  # 可选: pgAdmin（本地开发工具）
  # pgadmin:
  #   image: dpage/pgadmin4:latest
  #   container_name: eve_pgadmin
  #   restart: always
  #   environment:
  #     PGADMIN_DEFAULT_EMAIL: admin@example.com
  #     PGADMIN_DEFAULT_PASSWORD: admin
  #   ports:
  #     - "5050:80"
  #   depends_on:
  #     - eve-pg
  #   networks:
  #     - eve-network

networks:
  eve-network:
    driver: bridge
